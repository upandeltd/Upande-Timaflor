[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-05-01 21:08:15.591979",
  "module": "Upande Timaflor",
  "name": "Material Assigned To Employee",
  "script": "frappe.ui.form.on('Material Request', {\n    refresh(frm) {\n        handle_employee_assigned_logic(frm);\n    },\n\n    material_request_type(frm) {\n        handle_employee_assigned_logic(frm);\n    }\n});\n\nfunction handle_employee_assigned_logic(frm) {\n    frm.set_df_property(\"custom_employee_assigned_to\", \"hidden\", 1);\n    frm.set_df_property(\"custom_employee_assigned_to\", \"reqd\", 0);\n\n    if (frm.doc.material_request_type === \"Material Issue\") {\n        frm.set_df_property(\"custom_employee_assigned_to\", \"hidden\", 0);\n        frm.set_df_property(\"custom_employee_assigned_to\", \"reqd\", 1);\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-05-19 11:34:19.824867",
  "module": "Upande Timaflor",
  "name": "Biometric Script Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n    refresh(frm) {\n        console.log(\"Stock Entry Refresh - biometric logic\");\n        setTimeout(() => handle_stock_biometric_logic(frm), 300);\n    },\n    purpose(frm) {\n        console.log(\"Purpose changed - biometric logic\");\n        setTimeout(() => handle_stock_biometric_logic(frm), 300);\n    }\n});\n\n// Global flag to avoid duplicate button addition\nfrappe.stock_entry_biometric_button_added = frappe.stock_entry_biometric_button_added || {};\n\nfunction handle_stock_biometric_logic(frm) {\n    console.log(\"Handling biometric logic for Stock Entry\");\n\n    if (frm.doc.purpose === \"Material Issue\") {\n        frm.set_df_property(\"custom_biometric_data\", \"hidden\", 0);\n\n        const buttonKey = frm.doctype + frm.docname;\n        const buttonExists = frappe.stock_entry_biometric_button_added[buttonKey];\n\n        if (!buttonExists) {\n            console.log(\"Adding biometric button to Stock Entry\");\n            add_stock_biometric_button(frm);\n        }\n    } else {\n        frm.set_df_property(\"custom_biometric_data\", \"hidden\", 1);\n    }\n}\n\nfunction has_biometric_signature(frm) {\n    return (frm.doc.custom_biometric_data || []).length > 0;\n}\n\nfunction add_stock_biometric_button(frm) {\n    const buttonKey = frm.doctype + frm.docname;\n    frm.remove_custom_button('Add Biometric Signature');\n\n    if (frm.doc.purpose === \"Material Issue\") {\n        frm.add_custom_button('Add Biometric Signature', function () {\n            if (has_biometric_signature(frm)) {\n                frappe.msgprint('Biometric data already added.');\n                return;\n            }\n\n            frappe.call({\n                method: 'get_latest_biometric_log',\n                callback: function (result) {\n                    if (result && result.message) {\n                        if (result.message.error) {\n                            frappe.msgprint(result.message.error);\n                            return;\n                        }\n\n                        const log = result.message;\n                        const row = frappe.model.add_child(frm.doc, 'Biometric Signature', 'custom_biometric_data');\n                        row.employee = log.employee;\n                        row.employee_name = log.employee_name;\n                        row.biometric_id = log.biometric_id;\n                        row.timestamp = log.timestamp;\n                        frm.refresh_field('custom_biometric_data');\n\n                        if (!frm.is_new()) {\n                            frm.save();\n                        }\n\n                        frappe.msgprint('Biometric data added.');\n                    }\n                },\n                error: function (err) {\n                    frappe.msgprint(__('Error fetching biometric log: ') + (err.message || \"unknown error\"));\n                }\n            });\n        }, __(\"Actions\"));\n\n        frappe.stock_entry_biometric_button_added[buttonKey] = true;\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 0,
  "modified": "2025-06-10 15:05:32.600750",
  "module": "Upande Timaflor",
  "name": "Purchase Order Redirect",
  "script": "// Purchase Order client script\nfrappe.ui.form.on('Purchase Order', {\n    refresh: function(frm) {\n        if (frm.doc.docstatus === 1 && frappe.flags.just_submitted) {\n            frappe.flags.just_submitted = false; // Clear the flag\n            frappe.set_route('List', 'Purchase Order');\n        }\n    },\n    on_submit: function(frm) {\n        frappe.flags.just_submitted = true;\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 0,
  "modified": "2025-06-10 10:03:17.989897",
  "module": "Upande Timaflor",
  "name": "Biometric Signature",
  "script": "frappe.ui.form.on('Material Request', {\n    refresh(frm) {\n        handle_biometric_logic(frm);\n\n        // Add warning message if biometric signature is missing\n        if (frm.doc.docstatus === 1 && frm.doc.material_request_type === \"Material Issue\") {\n            if (!has_biometric_signature(frm)) {\n                frm.dashboard.add_comment(__('Please add a biometric signature before creating Material Issue.'), 'yellow');\n            }\n        }\n    },\n\n    material_request_type(frm) {\n        handle_biometric_logic(frm);\n    },\n\n    validate(frm) {\n        if (\n            frm.doc.material_request_type === \"Material Issue\" &&\n            frappe.flags.submit &&\n            !has_biometric_signature(frm)\n        ) {\n            frappe.throw(\"Biometric Signature is required before submitting a Material Issue request.\");\n        }\n    },\n\n   // Modified make_stock_entry function to pass employee data\n    make_stock_entry: function(frm) {\n        if (frm.doc.material_request_type === \"Material Issue\" && !has_biometric_signature(frm)) {\n            frappe.msgprint(__(\"Please add a biometric signature before creating Material Issue.\"));\n            return;\n        }\n        \n        // Get the employee from biometric data\n        let employee = null;\n        if (frm.doc.custom_biometric_data && frm.doc.custom_biometric_data.length > 0) {\n            employee = frm.doc.custom_biometric_data[0].employee;\n        }\n        \n        // If validation passes, open the mapped doc and set employee\n        frappe.model.open_mapped_doc({\n            method: \"erpnext.stock.doctype.material_request.material_request.make_stock_entry\",\n            frm: frm,\n            callback: function(r) {\n                if (r.doc && employee) {\n                    frappe.model.set_value(r.doc.doctype, r.doc.name, \"employee\", employee);\n                }\n            }\n        });\n    }\n});\n\nfunction handle_biometric_logic(frm) {\n    frm.set_df_property(\"custom_biometric_data\", \"hidden\", 1);\n    frm.set_df_property(\"custom_biometric_data\", \"reqd\", 0);\n    frm.remove_custom_button('Add Biometric Signature');\n\n    if (frm.doc.docstatus === 1 && frm.doc.material_request_type === \"Material Issue\") {\n        frm.set_df_property(\"custom_biometric_data\", \"hidden\", 0);\n        frm.set_df_property(\"custom_biometric_data\", \"reqd\", 1);\n        if (!has_biometric_signature(frm)) {\n            add_biometric_button(frm);\n        }\n    }\n}\n\nfunction has_biometric_signature(frm) {\n    return (frm.doc.custom_biometric_data || []).length > 0;\n}\n\nfunction add_biometric_button(frm) {\n    frm.add_custom_button('Add Biometric Signature', async () => {\n        if (has_biometric_signature(frm)) {\n            frappe.msgprint('Biometric data already added.');\n            frm.remove_custom_button('Add Biometric Signature');\n            return;\n        }\n\n        try {\n            const result = await frappe.call({\n                method: 'get_latest_biometric_log'\n            });\n\n            if (result && result.message) {\n                const log = result.message;\n                const row = frappe.model.add_child(frm.doc, 'Biometric Signature', 'custom_biometric_data');\n                row.employee = log.employee;\n                row.employee_name = log.employee_name;\n                row.biometric_id = log.biometric_id;\n                row.timestamp = log.timestamp;\n\n                frm.refresh_field('custom_biometric_data');\n                frappe.msgprint('Biometric data added.');\n                frm.remove_custom_button('Add Biometric Signature');\n            } else {\n                frappe.msgprint('No biometric log found in the last 30 seconds.');\n            }\n        } catch (e) {\n            frappe.msgprint(__('Error fetching biometric log: ') + e.message);\n        }\n    });\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-06-10 10:58:38.131955",
  "module": "Upande Timaflor",
  "name": "Material Request Redirect",
  "script": "frappe.ui.form.on('Material Request', {\n    on_submit(frm) {\n        frappe.set_route('List', 'Material Request');\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-06-18 12:51:05.323755",
  "module": null,
  "name": "Hide Clinician Issue Material Request",
  "script": "frappe.ui.form.on('Material Request', {\n    refresh: function(frm) {\n        // Immediately hide tables first, then check conditions\n        immediate_hide_check(frm);\n    },\n    \n    material_request_type: function(frm) {\n        immediate_hide_check(frm);\n    }\n});\n\n// Add event listener for items table changes\nfrappe.ui.form.on('Material Request Item', {\n    item_code: function(frm, cdt, cdn) {\n        immediate_hide_check(frm);\n    },\n    \n    items_remove: function(frm) {\n        immediate_hide_check(frm);\n    }\n});\n\nfunction immediate_hide_check(frm) {\n    // Check if current user has Clinician role\n    const has_clinician_role = frappe.user_roles.includes('Clinician');\n    \n    // Check if Material Request Type is \"Material Issue\"\n    const is_material_issue = frm.doc.material_request_type === 'Material Issue';\n    \n    // Only proceed if user doesn't have Clinician role AND it's Material Issue\n    if (!has_clinician_role && is_material_issue) {\n        // First do a quick synchronous check for MEDICAL items\n        const has_medical_sync = frm.doc.items && frm.doc.items.some(item => item.item_group === 'MEDICAL');\n        \n        if (has_medical_sync) {\n            // Immediately hide tables if MEDICAL items found synchronously\n            frm.set_df_property('items', 'hidden', 1);\n            frm.set_df_property('custom_employee_assigned_to', 'hidden', 1);\n            frm.refresh_fields();\n            \n            // Show access message immediately\n            frappe.msgprint({\n                title: __('Access Restricted'),\n                message: __('You do not have access to view this information'),\n                indicator: 'red'\n            });\n        } else {\n            // Do async check for MEDICAL items\n            check_for_medical_items_fast(frm).then(has_medical_items => {\n                if (has_medical_items) {\n                    // Hide tables if MEDICAL items found\n                    frm.set_df_property('items', 'hidden', 1);\n                    frm.set_df_property('custom_employee_assigned_to', 'hidden', 1);\n                    frm.refresh_fields();\n                    \n                    frappe.msgprint({\n                        title: __('Access Restricted'),\n                        message: __('You do not have access to view this information'),\n                        indicator: 'red'\n                    });\n                } else {\n                    // Show tables if no MEDICAL items found\n                    frm.set_df_property('items', 'hidden', 0);\n                    frm.set_df_property('custom_employee_assigned_to', 'hidden', 0);\n                    frm.refresh_fields();\n                }\n            });\n        }\n    } else {\n        // Show tables if user has access or it's not Material Issue\n        frm.set_df_property('items', 'hidden', 0);\n        frm.set_df_property('custom_employee_assigned_to', 'hidden', 0);\n        frm.refresh_fields();\n    }\n}\n\nfunction check_for_medical_items_fast(frm) {\n    return new Promise((resolve) => {\n        // Check if any items in the items table belong to \"MEDICAL\" item group\n        if (!frm.doc.items || frm.doc.items.length === 0) {\n            resolve(false);\n            return;\n        }\n        \n        // First do a quick synchronous check if item_group is already available\n        const has_medical_sync = frm.doc.items.some(item => item.item_group === 'MEDICAL');\n        if (has_medical_sync) {\n            resolve(true);\n            return;\n        }\n        \n        // If not found synchronously, do async check\n        let medical_item_found = false;\n        let completed_checks = 0;\n        const total_items = frm.doc.items.filter(item => item.item_code).length;\n        \n        if (total_items === 0) {\n            resolve(false);\n            return;\n        }\n        \n        // Check each item in the items table\n        frm.doc.items.forEach(item => {\n            if (item.item_code) {\n                // Get item details to check item group\n                frappe.db.get_value('Item', item.item_code, 'item_group')\n                    .then(r => {\n                        completed_checks++;\n                        \n                        if (r.message && r.message.item_group === 'MEDICAL') {\n                            medical_item_found = true;\n                        }\n                        \n                        // If all checks are complete, resolve the promise\n                        if (completed_checks === total_items) {\n                            resolve(medical_item_found);\n                        }\n                    })\n                    .catch(() => {\n                        completed_checks++;\n                        if (completed_checks === total_items) {\n                            resolve(medical_item_found);\n                        }\n                    });\n            }\n        });\n    });\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-06-18 12:52:11.612376",
  "module": "Upande Timaflor",
  "name": "Hide Clinician Issue Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n    refresh: function(frm) {\n        // Immediately hide tables first, then check conditions\n        immediate_hide_check(frm);\n    },\n    \n    stock_entry_type: function(frm) {\n        immediate_hide_check(frm);\n    }\n});\n\n// Add event listener for items table changes\nfrappe.ui.form.on('Stock Entry Detail', {\n    item_code: function(frm, cdt, cdn) {\n        immediate_hide_check(frm);\n    },\n    \n    items_remove: function(frm) {\n        immediate_hide_check(frm);\n    }\n});\n\nfunction immediate_hide_check(frm) {\n    // Check if current user has Clinician role\n    const has_clinician_role = frappe.user_roles.includes('Clinician');\n    \n    // Only proceed if user doesn't have Clinician role\n    if (!has_clinician_role) {\n        // First do a quick synchronous check for MEDICAL items\n        const has_medical_sync = frm.doc.items && frm.doc.items.some(item => item.item_group === 'MEDICAL');\n        \n        if (has_medical_sync) {\n            // Immediately hide tables if MEDICAL items found synchronously\n            frm.set_df_property('items', 'hidden', 1);\n            frm.set_df_property('custom_employee_assigned_to', 'hidden', 1);\n            frm.refresh_fields();\n            \n            // Show access message immediately\n            frappe.msgprint({\n                title: __('Access Restricted'),\n                message: __('You do not have access to view this information'),\n                indicator: 'red'\n            });\n        } else {\n            // Do async check for MEDICAL items\n            check_for_medical_items_fast(frm).then(has_medical_items => {\n                if (has_medical_items) {\n                    // Hide tables if MEDICAL items found\n                    frm.set_df_property('items', 'hidden', 1);\n                    frm.set_df_property('custom_employee_assigned_to', 'hidden', 1);\n                    frm.refresh_fields();\n                    \n                    frappe.msgprint({\n                        title: __('Access Restricted'),\n                        message: __('You do not have access to view this information'),\n                        indicator: 'red'\n                    });\n                } else {\n                    // Show tables if no MEDICAL items found\n                    frm.set_df_property('items', 'hidden', 0);\n                    frm.set_df_property('custom_employee_assigned_to', 'hidden', 0);\n                    frm.refresh_fields();\n                }\n            });\n        }\n    } else {\n        // Show tables if user has access\n        frm.set_df_property('items', 'hidden', 0);\n        frm.set_df_property('custom_employee_assigned_to', 'hidden', 0);\n        frm.refresh_fields();\n    }\n}\n\nfunction check_for_medical_items_fast(frm) {\n    return new Promise((resolve) => {\n        // Check if any items in the items table belong to \"MEDICAL\" item group\n        if (!frm.doc.items || frm.doc.items.length === 0) {\n            resolve(false);\n            return;\n        }\n        \n        // First do a quick synchronous check if item_group is already available\n        const has_medical_sync = frm.doc.items.some(item => item.item_group === 'MEDICAL');\n        if (has_medical_sync) {\n            resolve(true);\n            return;\n        }\n        \n        // If not found synchronously, do async check\n        let medical_item_found = false;\n        let completed_checks = 0;\n        const total_items = frm.doc.items.filter(item => item.item_code).length;\n        \n        if (total_items === 0) {\n            resolve(false);\n            return;\n        }\n        \n        // Check each item in the items table\n        frm.doc.items.forEach(item => {\n            if (item.item_code) {\n                // Get item details to check item group\n                frappe.db.get_value('Item', item.item_code, 'item_group')\n                    .then(r => {\n                        completed_checks++;\n                        \n                        if (r.message && r.message.item_group === 'MEDICAL') {\n                            medical_item_found = true;\n                        }\n                        \n                        // If all checks are complete, resolve the promise\n                        if (completed_checks === total_items) {\n                            resolve(medical_item_found);\n                        }\n                    })\n                    .catch(() => {\n                        completed_checks++;\n                        if (completed_checks === total_items) {\n                            resolve(medical_item_found);\n                        }\n                    });\n            }\n        });\n    });\n}",
  "view": "Form"
 }
]