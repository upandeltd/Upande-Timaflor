[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-05-01 21:08:15.591979",
  "module": "Upande Timaflor",
  "name": "Material Assigned To Employee",
  "script": "frappe.ui.form.on('Material Request', {\n    refresh(frm) {\n        handle_employee_assigned_logic(frm);\n    },\n\n    material_request_type(frm) {\n        handle_employee_assigned_logic(frm);\n    }\n});\n\nfunction handle_employee_assigned_logic(frm) {\n    frm.set_df_property(\"custom_employee_assigned_to\", \"hidden\", 1);\n    frm.set_df_property(\"custom_employee_assigned_to\", \"reqd\", 0);\n\n    if (frm.doc.material_request_type === \"Material Issue\") {\n        frm.set_df_property(\"custom_employee_assigned_to\", \"hidden\", 0);\n        frm.set_df_property(\"custom_employee_assigned_to\", \"reqd\", 1);\n    }\n}\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Material Request",
  "enabled": 1,
  "modified": "2025-05-18 15:07:44.804600",
  "module": "Upande Timaflor",
  "name": "Biometric Signature",
  "script": "frappe.ui.form.on('Material Request', {\n    refresh(frm) {\n        console.log(\"Refresh triggered - adding biometric button\");\n        if (frm.doc.docstatus === 0) {\n            setTimeout(() => handle_biometric_logic(frm), 300);\n\n            if (frm.doc.material_request_type === \"Material Issue\" && !has_biometric_signature(frm)) {\n                frm.dashboard.add_comment(__('Consider adding a biometric signature for verification.'), 'yellow');\n            }\n        }\n    },\n    validate(frm) {\n        console.log(\"Validate triggered\");\n    },\n    after_save(frm) {\n        console.log(\"After save triggered - adding biometric button\");\n        if (frm.doc.docstatus === 0) {\n            setTimeout(() => handle_biometric_logic(frm), 300);\n        }\n    },\n    onload(frm) {\n        console.log(\"Onload triggered - adding biometric button\");\n        if (frm.doc.docstatus === 0) {\n            setTimeout(() => handle_biometric_logic(frm), 300);\n        }\n    },\n    onload_post_render(frm) {\n        console.log(\"Onload post render triggered - adding biometric button\");\n        if (frm.doc.docstatus === 0) {\n            setTimeout(() => handle_biometric_logic(frm), 300);\n        }\n    },\n    material_request_type(frm) {\n        console.log(\"Material request type changed - adding biometric button\");\n        if (frm.doc.docstatus === 0) {\n            setTimeout(() => handle_biometric_logic(frm), 300);\n        }\n    },\n    make_stock_entry(frm) {\n        let employee = null;\n        if (frm.doc.custom_biometric_data && frm.doc.custom_biometric_data.length > 0) {\n            employee = frm.doc.custom_biometric_data[0].employee;\n        }\n        frappe.model.open_mapped_doc({\n            method: \"erpnext.stock.doctype.material_request.material_request.make_stock_entry\",\n            frm: frm,\n            callback: function(r) {\n                if (r.doc && employee) {\n                    frappe.model.set_value(r.doc.doctype, r.doc.name, \"employee\", employee);\n                }\n            }\n        });\n    }\n});\n\nfrappe.material_request_biometric_button_added = frappe.material_request_biometric_button_added || {};\n\nfunction handle_biometric_logic(frm) {\n    console.log(\"Handle biometric logic called\");\n\n    if (frm.doc.docstatus !== 0) return; // Exit if not in draft\n\n    if (frm.doc.material_request_type === \"Material Issue\") {\n        frm.set_df_property(\"custom_biometric_data\", \"hidden\", 0);\n\n        const buttonExists = frm.custom_buttons &&\n                            frm.custom_buttons['Add Biometric Signature'] &&\n                            frm.custom_buttons['Add Biometric Signature'].length > 0;\n\n        if (!buttonExists) {\n            console.log(\"Button does not exist, adding it now\");\n            add_biometric_button(frm);\n        } else {\n            console.log(\"Button already exists\");\n        }\n    } else {\n        frm.set_df_property(\"custom_biometric_data\", \"hidden\", 1);\n        frm.set_df_property(\"custom_biometric_data\", \"reqd\", 0);\n    }\n}\n\nfunction has_biometric_signature(frm) {\n    return (frm.doc.custom_biometric_data || []).length > 0;\n}\n\nfunction add_biometric_button(frm) {\n    console.log(\"Adding biometric button\");\n\n    if (frm.doc.docstatus !== 0) return; // Prevent adding button if submitted\n\n    const buttonKey = frm.doctype + frm.docname;\n    if (frappe.material_request_biometric_button_added[buttonKey]) {\n        console.log(\"Button was already added in this session, skipping\");\n        return;\n    }\n\n    frm.remove_custom_button('Add Biometric Signature');\n\n    if (frm.doc.material_request_type === \"Material Issue\") {\n        frm.add_custom_button('Add Biometric Signature', function() {\n            console.log(\"Button clicked\");\n\n            if (has_biometric_signature(frm)) {\n                frappe.msgprint('Biometric data already added.');\n                return;\n            }\n\n            frappe.call({\n                method: 'get_latest_biometric_log',\n                callback: function(result) {\n                    if (result && result.message) {\n                        if (result.message.error) {\n                            frappe.msgprint(result.message.error);\n                            return;\n                        }\n\n                        const log = result.message;\n                        const row = frappe.model.add_child(frm.doc, 'Biometric Signature', 'custom_biometric_data');\n                        row.employee = log.employee;\n                        row.employee_name = log.employee_name;\n                        row.biometric_id = log.biometric_id;\n                        row.timestamp = log.timestamp;\n                        frm.refresh_field('custom_biometric_data');\n\n                        if (!frm.is_new()) {\n                            frm.save();\n                        }\n\n                        frappe.msgprint('Biometric data added.');\n                    }\n                },\n                error: function(err) {\n                    frappe.msgprint(__('Error fetching biometric log: ') + (err.message || \"unknown error\"));\n                }\n            });\n        }, __(\"Actions\"));\n\n        frappe.material_request_biometric_button_added[buttonKey] = true;\n        console.log(\"Button added successfully\");\n    }\n}\n\n$(document).on('page-change', function() {\n    console.log(\"Page change detected\");\n    frappe.material_request_biometric_button_added = {};\n});\n\n$(document).on('form-refresh', function(event, frm) {\n    if (frm.doctype === 'Material Request' && frm.doc.docstatus === 0) {\n        console.log(\"Form refresh detected\");\n        setTimeout(() => handle_biometric_logic(frm), 500);\n    }\n});\n\nfrappe.ui.form.on('Material Request', 'after_render', function(frm) {\n    console.log(\"After render triggered\");\n\n    setTimeout(() => {\n        if (frm.doc.material_request_type === \"Material Issue\" && frm.doc.docstatus === 0) {\n            const targetNode = document.querySelector('.page-actions');\n            if (targetNode) {\n                const observer = new MutationObserver(function(mutations) {\n                    const buttonExists = document.querySelector('.btn-custom:contains(\"Add Biometric Signature\")');\n                    if (!buttonExists && frm.doc.material_request_type === \"Material Issue\") {\n                        console.log(\"Button was removed from DOM, adding it back\");\n                        add_biometric_button(frm);\n                    }\n                });\n\n                observer.observe(targetNode, { childList: true, subtree: true });\n            }\n        }\n    }, 1000);\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-05-18 15:09:49.424565",
  "module": "Upande Timaflor",
  "name": "Biometric Script  Stock Entry",
  "script": "frappe.ui.form.on('Stock Entry', {\n    refresh(frm) {\n        console.log(\"Stock Entry Refresh - biometric logic\");\n        setTimeout(() => handle_stock_biometric_logic(frm), 300);\n    },\n    purpose(frm) {\n        console.log(\"Purpose changed - biometric logic\");\n        setTimeout(() => handle_stock_biometric_logic(frm), 300);\n    }\n});\n\n// Global flag to avoid duplicate button addition\nfrappe.stock_entry_biometric_button_added = frappe.stock_entry_biometric_button_added || {};\n\nfunction handle_stock_biometric_logic(frm) {\n    console.log(\"Handling biometric logic for Stock Entry\");\n\n    if (frm.doc.purpose === \"Material Issue\") {\n        frm.set_df_property(\"custom_biometric_data\", \"hidden\", 0);\n\n        const buttonKey = frm.doctype + frm.docname;\n        const buttonExists = frappe.stock_entry_biometric_button_added[buttonKey];\n\n        if (!buttonExists) {\n            console.log(\"Adding biometric button to Stock Entry\");\n            add_stock_biometric_button(frm);\n        }\n    } else {\n        frm.set_df_property(\"custom_biometric_data\", \"hidden\", 1);\n    }\n}\n\nfunction has_biometric_signature(frm) {\n    return (frm.doc.custom_biometric_data || []).length > 0;\n}\n\nfunction add_stock_biometric_button(frm) {\n    const buttonKey = frm.doctype + frm.docname;\n    frm.remove_custom_button('Add Biometric Signature');\n\n    if (frm.doc.purpose === \"Material Issue\") {\n        frm.add_custom_button('Add Biometric Signature', function () {\n            if (has_biometric_signature(frm)) {\n                frappe.msgprint('Biometric data already added.');\n                return;\n            }\n\n            frappe.call({\n                method: 'get_latest_biometric_log',\n                callback: function (result) {\n                    if (result && result.message) {\n                        if (result.message.error) {\n                            frappe.msgprint(result.message.error);\n                            return;\n                        }\n\n                        const log = result.message;\n                        const row = frappe.model.add_child(frm.doc, 'Biometric Signature', 'custom_biometric_data');\n                        row.employee = log.employee;\n                        row.employee_name = log.employee_name;\n                        row.biometric_id = log.biometric_id;\n                        row.timestamp = log.timestamp;\n                        frm.refresh_field('custom_biometric_data');\n\n                        if (!frm.is_new()) {\n                            frm.save();\n                        }\n\n                        frappe.msgprint('Biometric data added.');\n                    }\n                },\n                error: function (err) {\n                    frappe.msgprint(__('Error fetching biometric log: ') + (err.message || \"unknown error\"));\n                }\n            });\n        }, __(\"Actions\"));\n\n        frappe.stock_entry_biometric_button_added[buttonKey] = true;\n    }\n}\n",
  "view": "Form"
 }
]